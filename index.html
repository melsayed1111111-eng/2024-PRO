<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ù„Ø¹Ø¨Ø© 2048 - Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠØ©</title>

    <!-- Ù…ÙƒØªØ¨Ø§Øª Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-analytics-compat.js"></script>

    <!-- Ø§Ù„Ø®Ø·ÙˆØ· -->
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;900&display=swap" rel="stylesheet">

    <style>
        /* --- Ø§Ù„ØªÙ†Ø³ÙŠÙ‚Ø§Øª (CSS) --- */
        
         :root {
            --bg-color: #faf8ef;
            --grid-bg: #bbada0;
            --cell-bg: rgba(238, 228, 218, 0.35);
            --text-dark: #776e65;
            --primary-btn: #8f7a66;
            --undo-btn: #e67e22;
            --store-btn: #27ae60;
        }
        
        body {
            margin: 0;
            padding: 0;
            font-family: 'Tajawal', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-dark);
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            user-select: none;
            overscroll-behavior: none;
            /* Ù…Ù†Ø¹ Ø§Ù„Ø³Ø­Ø¨ Ø§Ù„Ø²Ø§Ø¦Ø¯ ÙÙŠ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ */
        }
        
        .header-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 90%;
            max-width: 500px;
            margin-top: 20px;
        }
        
        .title {
            font-size: 60px;
            font-weight: 900;
            margin: 0;
            color: var(--text-dark);
        }
        
        .scores-container {
            display: flex;
            gap: 5px;
        }
        
        .score-box {
            background: #bbada0;
            padding: 10px 20px;
            border-radius: 6px;
            color: white;
            text-align: center;
            min-width: 70px;
        }
        
        .score-label {
            font-size: 12px;
            opacity: 0.8;
            text-transform: uppercase;
        }
        
        .score-val {
            font-size: 20px;
            font-weight: bold;
        }
        
        .controls-bar {
            display: flex;
            justify-content: space-between;
            width: 90%;
            max-width: 500px;
            margin: 15px 0;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            font-size: 16px;
            transition: transform 0.1s;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .btn:active {
            transform: scale(0.95);
        }
        
        .btn-new {
            background-color: var(--primary-btn);
        }
        
        .btn-undo {
            background-color: var(--undo-btn);
            position: relative;
        }
        
        .undo-count {
            background: white;
            color: var(--undo-btn);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 12px;
        }
        
        .btn-store {
            background-color: var(--store-btn);
        }
        
        .game-container {
            position: relative;
            width: 90vw;
            height: 90vw;
            max-width: 500px;
            max-height: 500px;
            background: var(--grid-bg);
            border-radius: 10px;
            padding: 10px;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            grid-template-rows: repeat(4, 1fr);
            gap: 10px;
            touch-action: none;
            /* Ù…Ù‡Ù… Ø¬Ø¯Ø§Ù‹ Ù„Ù„Ù…Ø³ */
        }
        
        .grid-cell {
            background: var(--cell-bg);
            border-radius: 5px;
            width: 100%;
            height: 100%;
        }
        
        .tile {
            position: absolute;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            border-radius: 5px;
            transition: all 0.15s ease-in-out;
            z-index: 10;
            animation: appear 0.2s ease-in-out;
        }
        
        @keyframes appear {
            0% {
                opacity: 0;
                transform: scale(0);
            }
            100% {
                opacity: 1;
                transform: scale(1);
            }
        }
        
        .tile-2 {
            background: #eee4da;
            color: #776e65;
            font-size: 45px;
        }
        
        .tile-4 {
            background: #ede0c8;
            color: #776e65;
            font-size: 45px;
        }
        
        .tile-8 {
            background: #f2b179;
            color: #f9f6f2;
            font-size: 40px;
        }
        
        .tile-16 {
            background: #f59563;
            color: #f9f6f2;
            font-size: 35px;
        }
        
        .tile-32 {
            background: #f67c5f;
            color: #f9f6f2;
            font-size: 35px;
        }
        
        .tile-64 {
            background: #f65e3b;
            color: #f9f6f2;
            font-size: 30px;
        }
        
        .tile-128 {
            background: #edcf72;
            color: #f9f6f2;
            font-size: 25px;
            box-shadow: 0 0 30px 10px rgba(243, 215, 116, 0.3);
        }
        
        .tile-256 {
            background: #edcc61;
            color: #f9f6f2;
            font-size: 25px;
            box-shadow: 0 0 30px 10px rgba(243, 215, 116, 0.4);
        }
        
        .tile-512 {
            background: #edc850;
            color: #f9f6f2;
            font-size: 25px;
        }
        
        .tile-1024 {
            background: #edc53f;
            color: #f9f6f2;
            font-size: 20px;
        }
        
        .tile-2048 {
            background: #edc22e;
            color: #f9f6f2;
            font-size: 20px;
            box-shadow: 0 0 30px 10px rgba(243, 215, 116, 0.5);
        }
        
        .ad-container {
            width: 90%;
            max-width: 500px;
            height: 60px;
            background: #e0e0e0;
            margin-top: 20px;
            border-radius: 5px;
            display: flex;
            justify-content: center;
            align-items: center;
            color: #999;
            font-size: 12px;
            border: 1px dashed #bbb;
        }
        
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 100;
            backdrop-filter: blur(5px);
        }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 400px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        
        .modal-title {
            font-size: 24px;
            margin-bottom: 15px;
            color: var(--text-dark);
        }
        
        .store-item {
            background: #f1f1f1;
            padding: 15px;
            margin: 10px 0;
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: 0.2s;
        }
        
        .store-item:hover {
            background: #e1e1e1;
        }
        
        .price-tag {
            background: #27ae60;
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 14px;
        }
        
        .close-modal {
            margin-top: 15px;
            background: #e74c3c;
            width: 100%;
        }
    </style>
</head>

<body>

    <div class="header-container">
        <h1 class="title">2048</h1>
        <div class="scores-container">
            <div class="score-box">
                <div class="score-label">Ø§Ù„Ù†ØªÙŠØ¬Ø©</div>
                <div class="score-val" id="score">0</div>
            </div>
            <div class="score-box">
                <div class="score-label">Ø§Ù„Ø£ÙØ¶Ù„</div>
                <div class="score-val" id="best-score">0</div>
            </div>
        </div>
    </div>

    <div class="controls-bar">
        <button class="btn btn-store" onclick="openStore()">ğŸ›’ Ø§Ù„Ù…ØªØ¬Ø±</button>
        <button class="btn btn-undo" onclick="undoMove()">â†©ï¸ ØªØ±Ø§Ø¬Ø¹ <span class="undo-count" id="undo-display">3</span></button>
        <button class="btn btn-new" onclick="startNewGame()">Ù„Ø¹Ø¨Ø© Ø¬Ø¯ÙŠØ¯Ø©</button>
    </div>

    <div class="game-container" id="game-board">
        <div class="grid-cell"></div>
        <div class="grid-cell"></div>
        <div class="grid-cell"></div>
        <div class="grid-cell"></div>
        <div class="grid-cell"></div>
        <div class="grid-cell"></div>
        <div class="grid-cell"></div>
        <div class="grid-cell"></div>
        <div class="grid-cell"></div>
        <div class="grid-cell"></div>
        <div class="grid-cell"></div>
        <div class="grid-cell"></div>
        <div class="grid-cell"></div>
        <div class="grid-cell"></div>
        <div class="grid-cell"></div>
        <div class="grid-cell"></div>
    </div>

    <div class="ad-container" id="ad-slot-1">
        <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6359877001554870" crossorigin="anonymous"></script>
        <span>Ù…Ø³Ø§Ø­Ø© Ø¥Ø¹Ù„Ø§Ù†ÙŠØ© (Google Ads)</span>
    </div>

    <div class="modal-overlay" id="store-modal">
        <div class="modal-content">
            <h2 class="modal-title">ğŸ’ Ù…ØªØ¬Ø± Ø§Ù„Ù„Ø¹Ø¨Ø©</h2>
            <p>Ù‚Ù… Ø¨ØªØ±Ù‚ÙŠØ© ØªØ¬Ø±Ø¨ØªÙƒ ÙˆØ§Ø¯Ø¹Ù… Ø§Ù„Ù…Ø·ÙˆØ±</p>
            <div class="store-item" onclick="simulatePurchase('undo_pack')">
                <div><strong>50 ØªØ±Ø§Ø¬Ø¹ Ø¥Ø¶Ø§ÙÙŠ</strong><br><small>ØµØ­Ø­ Ø£Ø®Ø·Ø§Ø¡Ùƒ ÙˆØ§Ø³ØªÙ…Ø±!</small></div>
                <span class="price-tag">1.99$</span>
            </div>
            <div class="store-item" onclick="simulatePurchase('no_ads')">
                <div><strong>Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª</strong><br><small>Ø§Ø´ØªØ±Ø§Ùƒ Ø´Ù‡Ø±ÙŠ</small></div>
                <span class="price-tag">0.99$/Ø´Ù‡Ø±</span>
            </div>
            <div class="store-item" onclick="simulatePurchase('theme_pack')">
                <div><strong>Ø£Ù„ÙˆØ§Ù† Ø«ÙŠÙ…Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©</strong><br><small>ØºÙŠØ± Ø´ÙƒÙ„ Ø§Ù„Ù„Ø¹Ø¨Ø©</small></div>
                <span class="price-tag">2.99$</span>
            </div>
            <button class="btn close-modal" onclick="closeStore()">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
    </div>

    <script>
        // =========================================================
        // 1. Ù…Ø­Ø±Ùƒ Ø§Ù„Ù„Ø¹Ø¨Ø© (ØªÙ… Ù†Ù‚Ù„Ù‡ Ù„Ù„Ø£Ø¹Ù„Ù‰ Ù„ÙŠØ¹Ù…Ù„ ÙÙˆØ±Ø§Ù‹)
        // =========================================================

        const boardSize = 4;
        let board = [];
        let score = 0;
        let bestScore = localStorage.getItem('2048-best') || 0;
        let undoLimit = 3;
        let previousState = null;

        const boardElement = document.getElementById('game-board');
        const scoreElement = document.getElementById('score');
        const bestScoreElement = document.getElementById('best-score');
        const undoDisplay = document.getElementById('undo-display');

        // ØªÙ‡ÙŠØ¦Ø© Ø£ÙˆÙ„ÙŠØ©
        bestScoreElement.innerText = bestScore;

        function startNewGame() {
            board = Array(boardSize * boardSize).fill(0);
            score = 0;
            scoreElement.innerText = 0;
            previousState = null;
            clearTiles();
            addRandomTile();
            addRandomTile();
            updateBoard();
            undoDisplay.innerText = undoLimit;
        }

        function clearTiles() {
            const tiles = document.querySelectorAll('.tile');
            tiles.forEach(tile => tile.remove());
        }

        function addRandomTile() {
            let emptyCells = [];
            board.forEach((val, index) => {
                if (val === 0) emptyCells.push(index);
            });
            if (emptyCells.length > 0) {
                let randIndex = emptyCells[Math.floor(Math.random() * emptyCells.length)];
                board[randIndex] = Math.random() > 0.9 ? 4 : 2;
            }
        }

        function updateBoard() {
            clearTiles();
            const width = boardElement.clientWidth / 4;
            board.forEach((val, index) => {
                if (val > 0) {
                    let tile = document.createElement('div');
                    tile.classList.add('tile', `tile-${val > 2048 ? 2048 : val}`);
                    tile.innerText = val;
                    let row = Math.floor(index / 4);
                    let col = index % 4;
                    tile.style.width = (width - 20) + 'px';
                    tile.style.height = (width - 20) + 'px';
                    tile.style.top = (row * width + 5) + 'px';
                    tile.style.left = (col * width + 5) + 'px';
                    boardElement.appendChild(tile);
                }
            });
        }

        function slide(row) {
            let arr = row.filter(val => val);
            let missing = boardSize - arr.length;
            let zeros = Array(missing).fill(0);
            arr = arr.concat(zeros);
            for (let i = 0; i < boardSize - 1; i++) {
                if (arr[i] !== 0 && arr[i] === arr[i + 1]) {
                    arr[i] *= 2;
                    score += arr[i];
                    arr[i + 1] = 0;
                }
            }
            arr = arr.filter(val => val);
            missing = boardSize - arr.length;
            zeros = Array(missing).fill(0);
            return arr.concat(zeros);
        }

        function move(direction) {
            let hasMoved = false;
            let oldBoard = [...board];

            // Ø­ÙØ¸ Ø§Ù„Ø­Ø§Ù„Ø© Ù„Ù„ØªØ±Ø§Ø¬Ø¹ Ù‚Ø¨Ù„ Ø§Ù„ØªØºÙŠÙŠØ±
            let tempScore = score;

            if (direction === 'left' || direction === 'right') {
                for (let i = 0; i < boardSize; i++) {
                    let row = [];
                    for (let j = 0; j < boardSize; j++) row.push(board[i * 4 + j]);
                    let newRow = (direction === 'right') ? slide(row.reverse()).reverse() : slide(row);
                    for (let j = 0; j < boardSize; j++) board[i * 4 + j] = newRow[j];
                }
            } else if (direction === 'up' || direction === 'down') {
                for (let j = 0; j < boardSize; j++) {
                    let col = [];
                    for (let i = 0; i < boardSize; i++) col.push(board[i * 4 + j]);
                    let newCol = (direction === 'down') ? slide(col.reverse()).reverse() : slide(col);
                    for (let i = 0; i < boardSize; i++) board[i * 4 + j] = newCol[i];
                }
            }

            if (JSON.stringify(oldBoard) !== JSON.stringify(board)) {
                // ØªÙ… Ø§Ù„ØªØ­Ø±Ùƒ Ø¨Ù†Ø¬Ø§Ø­
                saveState(oldBoard, tempScore); // Ø­ÙØ¸ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
                addRandomTile();
                scoreElement.innerText = score;
                if (score > bestScore) {
                    bestScore = score;
                    localStorage.setItem('2048-best', bestScore);
                    bestScoreElement.innerText = bestScore;
                }
                updateBoard();
            }
        }

        // --- Ù…Ø³ØªÙ…Ø¹Ø§Øª Ø§Ù„Ø£Ø­Ø¯Ø§Ø« (Event Listeners) ---

        // Ù„ÙˆØ­Ø© Ø§Ù„Ù…ÙØ§ØªÙŠØ­
        document.addEventListener('keydown', (e) => {
            if (e.key === 'ArrowRight') move('right');
            if (e.key === 'ArrowLeft') move('left');
            if (e.key === 'ArrowUp') move('up');
            if (e.key === 'ArrowDown') move('down');
        });

        // Ø§Ù„Ù„Ù…Ø³ (Ù„Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„)
        let touchStartX = 0;
        let touchStartY = 0;

        boardElement.addEventListener('touchstart', (e) => {
            touchStartX = e.changedTouches[0].screenX;
            touchStartY = e.changedTouches[0].screenY;
        }, {
            passive: false
        });

        boardElement.addEventListener('touchend', (e) => {
            e.preventDefault();
            let touchEndX = e.changedTouches[0].screenX;
            let touchEndY = e.changedTouches[0].screenY;
            let dx = touchEndX - touchStartX;
            let dy = touchEndY - touchStartY;

            if (Math.abs(dx) > Math.abs(dy)) {
                if (Math.abs(dx) > 10) { // Ø­Ø³Ø§Ø³ÙŠØ© Ø§Ù„Ù„Ù…Ø³
                    if (dx > 0) move('right');
                    else move('left');
                }
            } else {
                if (Math.abs(dy) > 10) {
                    if (dy > 0) move('down');
                    else move('up');
                }
            }
        }, {
            passive: false
        });

        // Ø§Ù„ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ©
        function saveState(oldBoard, oldScore) {
            previousState = {
                board: [...oldBoard],
                score: oldScore
            };
        }

        function undoMove() {
            if (undoLimit > 0) {
                if (previousState) {
                    board = previousState.board;
                    score = previousState.score;
                    scoreElement.innerText = score;
                    updateBoard();
                    previousState = null;
                    undoLimit--;
                    undoDisplay.innerText = undoLimit;
                } else {
                    alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø­Ø±ÙƒØ© Ø³Ø§Ø¨Ù‚Ø©!");
                }
            } else {
                openStore();
            }
        }

        function openStore() {
            document.getElementById('store-modal').style.display = 'flex';
        }

        function closeStore() {
            document.getElementById('store-modal').style.display = 'none';
        }

        function simulatePurchase(itemId) {
            alert("Ø¬Ø§Ø±Ù Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ø¯ÙØ¹...");
            setTimeout(() => {
                alert("ØªÙ… Ø§Ù„Ø´Ø±Ø§Ø¡ Ø¨Ù†Ø¬Ø§Ø­!");
                if (itemId === 'undo_pack') {
                    undoLimit += 50;
                    undoDisplay.innerText = undoLimit;
                }
                closeStore();
            }, 500);
        }

        // ØªØ´ØºÙŠÙ„ Ø§Ù„Ù„Ø¹Ø¨Ø© ÙÙˆØ±Ø§Ù‹
        startNewGame();
        window.addEventListener('resize', updateBoard);


        // =========================================================
        // 2. Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase (ÙÙŠ Ø§Ù„Ø£Ø³ÙÙ„ ÙˆÙ…Ø¹Ø²ÙˆÙ„Ø©)
        // =========================================================

        const firebaseConfig = {
            // Ø§Ø³ØªØ¨Ø¯Ù„ Ù‡Ø°Ù‡ Ø§Ù„Ù‚ÙŠÙ… Ø¨Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ© Ù…Ù† ÙƒÙˆÙ†Ø³ÙˆÙ„ ÙÙŠØ±Ø¨Ø§Ø³
            apiKey: "AIzaSyA03XF-ijDTp1C3jOcmo2ajZL4RvUlcZd0",
            authDomain: "gams-dca3f.firebaseapp.com",
            databaseURL: "https://gams-dca3f-default-rtdb.firebaseio.com",
            projectId: "gams-dca3f",
            storageBucket: "gams-dca3f.firebasestorage.app",
            messagingSenderId: "805484875796",
            appId: "1:805484875796:web:3f5390ad337f7f9c575701",
            measurementId: "G-R03SS18JVS"
        };

        // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„ÙÙŠØ±Ø¨Ø§Ø³ Ø¨Ø´ÙƒÙ„ Ø¢Ù…Ù†
        try {
            if (typeof firebase !== 'undefined') {
                firebase.initializeApp(firebaseConfig);
                console.log("ØªÙ… ØªÙ‡ÙŠØ¦Ø© Firebase");
            } else {
                console.log("Ù…ÙƒØªØ¨Ø© Firebase Ù„Ù… ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„Ù‡Ø§ (ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª)");
            }
        } catch (error) {
            // Ù‡Ø°Ø§ Ù‡Ùˆ Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ù…Ù‡Ù…: Ø¥Ø°Ø§ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŒ Ù„Ù† ØªØªÙˆÙ‚Ù Ø§Ù„Ù„Ø¹Ø¨Ø©
            console.warn("ØªÙ†Ø¨ÙŠÙ‡: Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Firebase Ù„Ø£Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± ØµØ­ÙŠØ­Ø©ØŒ Ù„ÙƒÙ† Ø§Ù„Ù„Ø¹Ø¨Ø© Ø³ØªØ¹Ù…Ù„.");
        }
    </script>
</body>

</html>
